<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            margin: 0;
            background: linear-gradient(to bottom, #70c5ce, #ffffff);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        h1 {
            margin: 20px 0 10px;
            font-size: 2rem;
            color: #222;
        }

        #instructions {
            font-size: 0.9rem;
            margin-bottom: 15px;
            color: #444;
        }

        #board {
            width: 360px;
            max-width: 92vw;
            height: auto;
            display: block;
        }

        #scoreDisplay {
            font-size: 1.2rem;
            margin: 10px 0;
            font-weight: bold;
        }

        /* Game Over Popup */
        #gameOverPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: black;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none;
            z-index: 10;
        }

        #gameOverPopup h2 {
            margin-bottom: 15px;
        }

        #restartBtn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        #restartBtn:hover {
            background: #218838;
        }

        /* Back button */
        #backBtn {
            margin-top: 15px;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        #backBtn:hover {
            background: #0056b3;
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.4rem;
            }

            #instructions {
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <h1>Flappy Bird</h1>
    <div id="instructions">Press <b>Space</b> or <b>↑</b> to flap</div>
    <div id="scoreDisplay">Score: 0</div>
    <canvas id="board"></canvas>

    <a href="index.html" id="backBtn">⬅ Back to Game Hub</a>

    <!-- Game Over Popup -->
    <div id="gameOverPopup">
        <h2>Game Over</h2>
        <p id="finalScore"></p>
        <button id="restartBtn">Restart</button>
    </div>

    <script>
        // Board setup
        let board;
        let boardWidth = 360;
        let boardHeight = 640;
        let context;

        // Bird
        let birdWidth = 34;
        let birdHeight = 24;
        let birdX = boardWidth / 8;
        let birdY = boardHeight / 2;
        let birdImg;
        let bird = { x: birdX, y: birdY, width: birdWidth, height: birdHeight };

        // Pipes
        let pipeArray = [];
        let pipeWidth = 64;
        let pipeHeight = 512;
        let pipeX = boardWidth;
        let pipeY = 0;
        let topPipeImg, bottomPipeImg;

        // Physics
        let velocityX = -2;
        let velocityY = 0;
        let gravity = 0.4;

        // Game state
        let gameOver = false;
        let score = 0;

        window.onload = function () {
            board = document.getElementById("board");
            // set size responsive and keep original aspect ratio (360x640)
            const maxW = Math.min(360, Math.floor(window.innerWidth * 0.9));
            const ratio = 360 / 640;
            const w = maxW;
            const h = Math.round(w / ratio);
            board.width = w;
            board.height = h;
            context = board.getContext("2d");

            // Load images
            birdImg = new Image();
            birdImg.src = "./flappybird.gif";
            birdImg.onload = function () {
                context.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height);
            }

            topPipeImg = new Image();
            topPipeImg.src = "./toppipe.png";
            bottomPipeImg = new Image();
            bottomPipeImg.src = "./bottompipe.png";

            requestAnimationFrame(update);
            setInterval(placePipes, 1500);
            document.addEventListener("keydown", moveBird);
            board.addEventListener("touchstart", moveBird, { passive: false });
            document.getElementById("restartBtn").addEventListener("click", restartGame);
        }

        window.addEventListener('resize', () => {
            if (!board) return;
            const maxW = Math.min(360, Math.floor(window.innerWidth * 0.9));
            const ratio = 360 / 640;
            const w = maxW;
            const h = Math.round(w / ratio);
            board.width = w;
            board.height = h;
        });

        function update() {
            requestAnimationFrame(update);
            if (gameOver) return;

            context.clearRect(0, 0, board.width, board.height);

            // Bird physics
            velocityY += gravity;
            bird.y = Math.max(bird.y + velocityY, 0);
            context.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height);

            if (bird.y > board.height) gameOver = true;

            // Pipes
            for (let i = 0; i < pipeArray.length; i++) {
                let pipe = pipeArray[i];
                pipe.x += velocityX;
                context.drawImage(pipe.img, pipe.x, pipe.y, pipe.width, pipe.height);

                if (!pipe.passed && bird.x > pipe.x + pipe.width) {
                    score += 0.5;
                    pipe.passed = true;
                    document.getElementById("scoreDisplay").innerText = "Score: " + score;
                }

                if (detectCollision(bird, pipe)) gameOver = true;
            }

            // Clear old pipes
            while (pipeArray.length > 0 && pipeArray[0].x < -pipeWidth) {
                pipeArray.shift();
            }

            if (gameOver) {
                document.getElementById("finalScore").innerText = "Your Score: " + score;
                document.getElementById("gameOverPopup").style.display = "block";
            }

        }

        function placePipes() {
            if (gameOver) return;

            let randomPipeY = pipeY - pipeHeight / 4 - Math.random() * (pipeHeight / 2);
            let openingSpace = board.height / 4;

            let topPipe = { img: topPipeImg, x: pipeX, y: randomPipeY, width: pipeWidth, height: pipeHeight, passed: false };
            let bottomPipe = {
                img: bottomPipeImg,
                x: pipeX,
                y: randomPipeY + pipeHeight + openingSpace,
                width: pipeWidth,
                height: pipeHeight,
                passed: false
            };

            pipeArray.push(topPipe, bottomPipe);
        }

        function moveBird(e) {
            if (e.code == "Space" || e.code == "ArrowUp" || e.code == "KeyX" || e.type === 'touchstart') {
                velocityY = -6;
            }
            if (e.type === 'touchstart') {
                e.preventDefault();
            }
        }

        function detectCollision(a, b) {
            return a.x < b.x + b.width &&
                a.x + a.width > b.x &&
                a.y < b.y + b.height &&
                a.y + a.height > b.y;
        }

        function showGameOver() {
            document.getElementById("finalScore").innerText = "Your Score: " + score;
            document.getElementById("gameOverPopup").style.display = "block";
        }

        function restartGame() {
            bird.y = birdY;
            pipeArray = [];
            score = 0;
            velocityY = 0;
            gameOver = false;
            document.getElementById("scoreDisplay").innerText = "Score: 0";
            document.getElementById("gameOverPopup").style.display = "none";
        }

        document.getElementById("restartBtn").addEventListener("click", () => {
            // Reset game
            bird.y = birdY;
            pipeArray = [];
            score = 0;
            gameOver = false;
            velocityY = 0;
            document.getElementById("gameOverPopup").style.display = "none";
        });
    </script>
</body>

</html>